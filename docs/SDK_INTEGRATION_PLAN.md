# ğŸš€ Claude Agent SDK æ•´åˆå®æ–½è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°å¦‚ä½•å°† `@anthropic-ai/claude-agent-sdk` æ•´åˆåˆ° Opcode é¡¹ç›®ä¸­ï¼Œä»¥å®ç°æ›´å¼ºå¤§çš„ AI Agent åŠŸèƒ½ã€‚

## æ¶æ„è®¾è®¡

### å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Tauri IPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     CLI Process    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Frontend     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Rust Backend  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Claude CLI    â”‚
â”‚    (React)      â”‚                    â”‚    (Tauri)      â”‚                    â”‚   (Subprocess)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Tauri IPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Node IPC       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Frontend     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Rust Backend  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   SDK Service   â”‚
â”‚    (React)      â”‚                    â”‚    (Tauri)      â”‚                    â”‚   (Node.js)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                                            â”‚
         â”‚                              Direct SDK Calls                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         (Option B)
```

## æ¨¡å—è®¾è®¡

### 1. SDK æœåŠ¡æ ¸å¿ƒ (`src/services/sdk/`)

- `index.ts` - æœåŠ¡å…¥å£å’Œå¯¼å‡º
- `SdkAgentEngine.ts` - Agent æ‰§è¡Œå¼•æ“
- `SdkSessionManager.ts` - ä¼šè¯ç®¡ç†å™¨
- `SdkMcpTools.ts` - è‡ªå®šä¹‰ MCP å·¥å…·
- `SdkHooks.ts` - Hook ç³»ç»Ÿå®ç°
- `types.ts` - TypeScript ç±»å‹å®šä¹‰

### 2. åŠŸèƒ½æ¨¡å—

#### 2.1 Native SDK Agent æ‰§è¡Œå¼•æ“

- ä½¿ç”¨ `query()` API æ›¿ä»£ CLI è°ƒç”¨
- æµå¼æ¶ˆæ¯å¤„ç†
- å®Œæ•´çš„ Hook æ”¯æŒ
- æƒé™æ§åˆ¶å›è°ƒ

#### 2.2 å¢å¼ºä¼šè¯ç®¡ç†

- SDKSession æ¥å£å°è£…
- ä¼šè¯æŒä¹…åŒ–
- Resume/Fork åŠŸèƒ½
- å®æ—¶çŠ¶æ€ç›‘æ§

#### 2.3 è‡ªå®šä¹‰ MCP å·¥å…·

- Opcode ä¸“å±å·¥å…·é›†
- ä¸ Tauri åç«¯é›†æˆ
- é¡¹ç›®ä¿¡æ¯æŸ¥è¯¢
- è‡ªå®šä¹‰æ“ä½œæ‰§è¡Œ

#### 2.4 ç»“æ„åŒ–è¾“å‡º

- JSON Schema å®šä¹‰
- ç±»å‹å®‰å…¨å¤„ç†
- å“åº”éªŒè¯

## æ–‡ä»¶ç»“æ„

```
src/services/sdk/
â”œâ”€â”€ index.ts                 # æœåŠ¡å…¥å£
â”œâ”€â”€ types.ts                 # ç±»å‹å®šä¹‰
â”œâ”€â”€ SdkAgentEngine.ts        # Agent æ‰§è¡Œå¼•æ“
â”œâ”€â”€ SdkSessionManager.ts     # ä¼šè¯ç®¡ç†
â”œâ”€â”€ SdkMcpTools.ts           # è‡ªå®šä¹‰ MCP å·¥å…·
â”œâ”€â”€ SdkHooks.ts              # Hook ç³»ç»Ÿ
â”œâ”€â”€ SdkPermissionHandler.ts  # æƒé™å¤„ç†
â””â”€â”€ SdkEventBridge.ts        # äº‹ä»¶æ¡¥æ¥ (SDK <-> Tauri)
```

## å®æ–½é˜¶æ®µ

### Phase 1: åŸºç¡€è®¾æ–½ âœ…

- [x] åˆ›å»ºç›®å½•ç»“æ„
- [x] å®šä¹‰ç±»å‹ç³»ç»Ÿ
- [x] å®ç°äº‹ä»¶æ¡¥æ¥

### Phase 2: æ ¸å¿ƒå¼•æ“

- [ ] å®ç° SdkAgentEngine
- [ ] æµå¼æ¶ˆæ¯å¤„ç†
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶

### Phase 3: ä¼šè¯ç®¡ç†

- [ ] å®ç° SdkSessionManager
- [ ] ä¼šè¯æŒä¹…åŒ–
- [ ] Resume/Fork åŠŸèƒ½

### Phase 4: å·¥å…·æ‰©å±•

- [ ] å®ç°è‡ªå®šä¹‰ MCP å·¥å…·
- [ ] ä¸ Tauri åç«¯é›†æˆ

### Phase 5: é«˜çº§åŠŸèƒ½

- [ ] ç»“æ„åŒ–è¾“å‡º
- [ ] å­ä»£ç†ç³»ç»Ÿ
- [ ] æ–‡ä»¶æ£€æŸ¥ç‚¹

## API è®¾è®¡

### SdkAgentEngine

```typescript
interface SdkAgentEngine {
  // æ‰§è¡Œ Agent æŸ¥è¯¢
  execute(options: ExecuteOptions): AsyncGenerator<SdkMessage>;

  // ä¸­æ–­æ‰§è¡Œ
  interrupt(): Promise<void>;

  // åŠ¨æ€æ§åˆ¶
  setModel(model: string): Promise<void>;
  setMaxThinkingTokens(tokens: number): Promise<void>;

  // è·å–çŠ¶æ€
  getStatus(): EngineStatus;
  getAccountInfo(): Promise<AccountInfo>;
  getSupportedModels(): Promise<ModelInfo[]>;
}
```

### SdkSessionManager

```typescript
interface SdkSessionManager {
  // åˆ›å»ºæ–°ä¼šè¯
  create(options: SessionOptions): Promise<SdkSession>;

  // æ¢å¤ä¼šè¯
  resume(sessionId: string): Promise<SdkSession>;

  // åˆ†å‰ä¼šè¯
  fork(sessionId: string, atMessageId?: string): Promise<SdkSession>;

  // è·å–ä¼šè¯
  get(sessionId: string): SdkSession | undefined;

  // åˆ—å‡ºä¼šè¯
  list(): SdkSession[];

  // å…³é—­ä¼šè¯
  close(sessionId: string): Promise<void>;
}
```

### CustomMcpTool

```typescript
interface CustomMcpTool {
  name: string;
  description: string;
  inputSchema: ZodSchema;
  handler: (input: any) => Promise<ToolResult>;
}
```

## å…¼å®¹æ€§è€ƒè™‘

1. **æ¸è¿›å¼è¿ç§»**: ä¿æŒç°æœ‰ CLI è°ƒç”¨æ–¹å¼ï¼ŒSDK ä½œä¸ºå¯é€‰å¢å¼º
2. **äº‹ä»¶å…¼å®¹**: ä¿æŒç°æœ‰ Tauri äº‹ä»¶æ ¼å¼ï¼ŒSDK æ¶ˆæ¯è½¬æ¢ä¸ºå…¼å®¹æ ¼å¼
3. **é…ç½®å…¼å®¹**: å¤ç”¨ç°æœ‰é…ç½®æ–‡ä»¶å’Œè®¾ç½®

## é£é™©ä¸ç¼“è§£

| é£é™©             | ç¼“è§£æªæ–½                         |
| ---------------- | -------------------------------- |
| SDK ç‰ˆæœ¬ä¸ç¨³å®š   | é”å®šç‰ˆæœ¬ï¼Œå…³æ³¨æ›´æ–°æ—¥å¿—           |
| Node.js è¿›ç¨‹ç®¡ç† | ä½¿ç”¨ Tauri sidecar æˆ– shell æ’ä»¶ |
| å†…å­˜å ç”¨å¢åŠ      | ç›‘æ§å¹¶ä¼˜åŒ–ï¼ŒæŒ‰éœ€åŠ è½½             |
| è°ƒè¯•å¤æ‚åº¦       | å®Œå–„æ—¥å¿—ç³»ç»Ÿ                     |

## ä¸‹ä¸€æ­¥

1. åˆ›å»º SDK æœåŠ¡ç›®å½•ç»“æ„
2. å®ç°ç±»å‹å®šä¹‰
3. å®ç° SdkAgentEngine æ ¸å¿ƒ
4. æ·»åŠ äº‹ä»¶æ¡¥æ¥å±‚
5. é›†æˆåˆ°ç°æœ‰ç»„ä»¶
